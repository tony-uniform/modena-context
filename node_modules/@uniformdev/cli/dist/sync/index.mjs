import{b as h,c as l,d as _}from"../chunk-64DQ4B7X.mjs";l();l();async function H({objects:t,selectIdentifier:e,selectDisplayName:n=e,onSyncComplete:r}){let c=t.reduce((o,a)=>{let i=e(a);if(o[i])throw new Error(`Identifier ${i} was not unique.`);return o[i]={id:i,object:a,providerId:i,displayName:n(a)},o},{});async function*p(){for(let o of Object.values(c))yield o}function g(){return Object.entries(c).sort((o,a)=>o[0].localeCompare(a[0])).map(o=>o[1].object)}return{objects:p(),deleteObject:async o=>{delete c[o]},writeObject:async o=>{let a=e(o.object);c[a]=o},extractCurrent:g,onSyncComplete:r?o=>r(o,g()):void 0}}l();var C=h(_());import{existsSync as R,mkdirSync as M}from"fs";import{readdir as L,unlink as $}from"fs/promises";import{extname as J,join as P}from"path";l();import{dump as F,load as N}from"js-yaml";import{writeFileSync as U}from"fs";import{extname as A}from"path";import{readFileSync as k}from"fs";function Q(t){var e,n;return t.option("apiKey",{describe:"Uniform API key. Defaults to CANVAS_CLI_API_KEY or UNIFORM_API_KEY env. Supports dotenv.",default:(n=(e=process.env.CANVAS_CLI_API_KEY)!=null?e:process.env.UPM_CLI_API_KEY)!=null?n:process.env.UNIFORM_API_KEY,demandOption:!0,type:"string"}).option("apiHost",{describe:"Uniform host. Defaults to UNIFORM_CLI_BASE_URL env or https://uniform.app. Supports dotenv.",default:process.env.UNIFORM_CLI_BASE_URL||"https://uniform.app",demandOption:!0,type:"string"})}function X(t){var e,n,r;return t.option("project",{describe:"Uniform project ID. Defaults to UNIFORM_CLI_PROJECT_ID or UNIFORM_PROJECT_ID env. Supports dotenv.",default:(r=(n=(e=process.env.UNIFORM_CLI_PROJECT_ID)!=null?e:process.env.CANVAS_CLI_PROJECT_ID)!=null?n:process.env.UPM_CLI_PROJECT_ID)!=null?r:process.env.UNIFORM_PROJECT_ID,demandOption:!0,type:"string",alias:["p"]})}function Z(t){return t.option("format",{alias:["f"],describe:"Output format",default:"yaml",choices:["yaml","json"],type:"string"}).option("filename",{alias:["o"],describe:"Output filename. If not specified, write to stdout.",type:"string"})}function ee(t){var e;return t.option("diff",{describe:"Whether to show diffs in stdout. off = no diffs; update = on for updates; on = updates, creates, deletes. Can be set by UNIFORM_CLI_DIFF_MODE environment variable.",default:(e=process.env.UNIFORM_CLI_DIFF_MODE)!=null?e:"off",type:"string",choices:["off","update","on"],alias:["d"]})}function te(t){let e=A(t);return e===".yaml"||e===".yml"||e===".json"}function I(t,e,n){let r;if(n&&!e){let c=A(n);c===".yaml"||c===".yml"?e="yaml":c===".json"&&(e="json")}else if(!e)throw new Error("Format must be specified when no filename is passed");switch(e){case"json":r=JSON.stringify(t,null,2);break;case"yaml":r=F(t);break;default:throw new Error(`Unsupported format: ${e}`)}n?U(n,r,"utf8"):console.log(r)}function w(t){let e=k(t,"utf8");return N(e,{filename:t,json:!0})}async function*ne(t,e){let n=e.pageSize||100,r=0,c=[];do{c=await t(r,n);for(let p of c)yield p;r+=n}while(c.length===n)}async function ce({directory:t,format:e="yaml",selectIdentifier:n,selectDisplayName:r=n}){R(t)||M(t,{recursive:!0});let p=await L(t,"utf-8"),g=new Set(p.filter(i=>{let f=J(i);return f===".json"||f===".yaml"||f===".yml"})),o=i=>P(t,`${i}.${e}`);async function*a(){for(let i of g){let f=P(t,i);try{let s=await w(f);yield{id:n(s),displayName:r(s),providerId:f,object:s}}catch(s){throw console.error(C.default.red(`Failed to read ${f}, data is likely invalid.
${s==null?void 0:s.message}`)),s}}}return{objects:a(),deleteObject:async i=>{await $(i)},writeObject:async i=>{I(i.object,e,o(i.id))}}}l();import K from"fs";function le(t,e){if(!e&&!K.existsSync(t))return{};let n=w(t);if(typeof n!="object")throw new Error(`Package ${t} does not appear valid.`);return n}function me(t,e){I(e,void 0,t)}l();import{diffJson as W,diffLines as D}from"diff";import Y from"lodash.isequalwith";async function Oe({source:t,target:e,compareContents:n=(o,a)=>Y(o.object,a.object,(i,f,s)=>s==="created"||s==="modified"?!0:void 0),mode:r,allowEmptySource:c=!1,whatIf:p=!1,log:g=()=>{}}){var f,s;let o=new Map;for await(let m of e.objects)o.set(m.id,m);let a=[],i=!1;for await(let m of t.objects){i=!0;let j=m.id,E=o.get(j);if(E){if(!n(m,E)&&(r==="createOrUpdate"||r==="mirror")){let y=async(d,u)=>{var v;if(!p)try{await e.writeObject(d,u)}catch(x){throw new b(x,d)}g({action:"update",id:j,providerId:d.providerId,displayName:(v=d.displayName)!=null?v:d.providerId,whatIf:p,diff:W(u.object,d.object)})};a.push(y(m,E))}o.delete(j)}else{let y=async(d,u)=>{var v;if(!p)try{await e.writeObject(d)}catch(x){throw new b(x,d)}g({action:"create",id:u,providerId:u,displayName:(v=d.displayName)!=null?v:d.providerId,whatIf:p,diff:D("",JSON.stringify(d.object,null,2))})};a.push(y(m,j))}}if(await Promise.all(a),r==="mirror"){if(!i&&!c)throw new Error("Source is empty and mode is mirror. This would cause deletion of everything in the target, and most likely indicates an error in source definition.");let m=[];o.forEach(async j=>{let E=async y=>{var d;if(!p)try{await e.deleteObject(y.providerId)}catch(u){throw new b(u,y)}g({action:"delete",id:y.id,providerId:y.providerId,displayName:(d=y.displayName)!=null?d:y.providerId,whatIf:p,diff:D(JSON.stringify(y.object,null,2),"")})};m.push(E(j))}),await Promise.all(m)}await Promise.all([(f=t.onSyncComplete)==null?void 0:f.call(t,!1),(s=e.onSyncComplete)==null?void 0:s.call(e,!0)])}var b=class extends Error{constructor(e,n){var r;super(`Error syncing ${(r=n.displayName)!=null?r:n.providerId} (${n.providerId})
${e}`),this.stack=void 0,Object.setPrototypeOf(this,b.prototype)}};l();var O=h(_());function Se(t){let{diffMode:e="off",indent:n,prefix:r}=t!=null?t:{};return function({action:p,displayName:g,whatIf:o,diff:a}){let i="";switch(p){case"create":i=O.default.green("[A]");break;case"update":i=O.default.white("[U]");break;case"delete":i=O.default.yellow("[D]");break}let f="";(e==="on"||e==="update"&&p==="update")&&(f=`
`+a.map(s=>s.added?O.default.green(s.value):s.removed?O.default.red(s.value):s.value).join("")),console.log(`${n!=null?n:""}${o?O.default.gray("[WHATIF]"):""}${i}${r!=null?r:""} ${g}${f}`)}}export{b as SyncEngineError,H as createArraySyncEngineDataSource,ce as createFileSyncEngineDataSource,Se as createSyncEngineConsoleLogger,I as emitWithFormat,te as isPathAPackageFile,ne as paginateAsync,w as readFileToObject,le as readUniformPackage,Oe as syncEngine,Q as withApiOptions,ee as withDiffOptions,Z as withFormatOptions,X as withProjectOptions,me as writeUniformPackage};
