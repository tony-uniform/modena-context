var V=Object.defineProperty;var B=Object.getOwnPropertyDescriptor;var U=Object.getOwnPropertyNames;var q=Object.prototype.hasOwnProperty;var D=(e,t)=>{for(var n in t)V(e,n,{get:t[n],enumerable:!0})},z=(e,t,n,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let c of U(t))!q.call(e,c)&&c!==n&&V(e,c,{get:()=>t[c],enumerable:!(o=B(t,c))||o.enumerable});return e};var K=e=>z(V({},"__esModule",{value:!0}),e);var ie={};D(ie,{CANVAS_CONTENTFUL_MULTI_PARAMETER_TYPES:()=>Q,CANVAS_CONTENTFUL_PARAMETER_TYPES:()=>N,CANVAS_CONTENTFUL_QUERY_PARAMETER_TYPES:()=>_,ContentfulClientList:()=>v,contentfulRichTextToHtmlEnhancer:()=>re,createContentfulEnhancer:()=>H,createContentfulMultiEnhancer:()=>J,createContentfulQueryEnhancer:()=>Z});module.exports=K(ie);var $=require("@uniformdev/canvas");var v=class{constructor(t){this._clients={},Array.isArray(t)?t.forEach(n=>this.addClient(n)):t&&this.addClient(t)}addClient({source:t="default",client:n,previewClient:o}){if(this._clients[t])throw new Error(`The source ${t} is always registered`);if(!n)throw new Error("You must provide a Contentful client for the ContentfulClientList");this._clients[t]={client:n,previewClient:o||n}}getClient({source:t="default",isPreviewClient:n}){let o=this._clients[t];if(!!o)return n?o.previewClient:o.client}};var O=require("@uniformdev/canvas"),x=(0,O.createLimitPolicy)({throttle:{limit:55,interval:1e3}});function P(e){return typeof e=="string"?e:typeof e=="object"&&e&&"error"in e?e.error:e instanceof Error?e.toString():JSON.stringify(e,null,2)}function R(e,t){if(!!e)return`${t==="desc"?"-":""}${e}`}function T({clients:e,parameterValue:t,parameterName:n,component:o,context:c}){let{source:i="default"}=t,a=e.getClient({source:i,isPreviewClient:c.preview});if(!a)throw new Error(`No Contentful client could be resolved for source key '${i}' referenced in parameter '${n} in component '${o.type}'. Ensure that the 'clients' property you are passing to the enhancer has a client instance registered for the source key.`);return a}var L={select:"fields",include:1},N=Object.freeze(["contentfulEntry"]);function G(e){return e instanceof v}function H({client:e,previewClient:t,createQuery:n,useBatching:o,limitPolicy:c}){if(!e)throw new Error("No Contentful clients were provided to the enhancer. You must provide at least one client via the `client` or `clients` property.");let a=(()=>{if(G(e))return e;let s=new v;return s.addClient({client:e,previewClient:t}),s})(),d=c||x;return o?(0,$.createBatchEnhancer)({handleBatch:async s=>{var f;let l=s.reduce((u,r)=>{let{parameter:C,parameterName:m,component:E,context:p}=r.args,h=C.value;if(!F(h))return u;let g=M({parameterValue:h,parameterName:m,clients:a,component:E,context:p}),y="";if(A(h))y="legacy-group";else{let{source:Y="default"}=h;y=Y}return u[y]&&Array.isArray(u[y].tasks)?u[y].tasks.push(r):u[y]={client:g,tasks:[r]},u},{});try{console.time("fetch all entries");for await(let[u,r]of Object.entries(l)){let{context:C,component:m}=r.tasks[0].args,E=(f=n==null?void 0:n({component:m,defaultQuery:{...L},context:C}))!=null?f:L,p=new $.UniqueBatchEntries(r.tasks,g=>A(g.parameter.value)?g.parameter.value:g.parameter.value.entryId),h=Object.keys(p.groups);console.time(`fetch entries ${u}`);try{(await r.client.getEntries({"sys.id[in]":h.join(","),limit:h.length,...E})).items.forEach(y=>{p.resolveKey(y.sys.id,y)}),p.resolveRemaining(null)}finally{console.timeEnd(`fetch entries ${u}`)}}console.timeEnd("fetch all entries")}catch(u){let r=P(u),C=new Error(`Failed loading Contentful entries batch (${s.length}) ${r}`);s.forEach(m=>m.reject(C))}},shouldQueue:({parameter:s})=>b(s),limitPolicy:d}):{enhanceOne:async function({parameter:l,parameterName:f,component:u,context:r}){var C,m;if(b(l)){if(!F(l.value))return null;let E=M({clients:a,parameterName:f,parameterValue:l.value,component:u,context:r}),p=A(l.value)?l.value:l.value.entryId,h=(C=n==null?void 0:n({parameter:l,parameterName:f,component:u,defaultQuery:{...L},context:r}))!=null?C:L;try{return console.time(`fetch entry ${p}`),await E.getEntry(p,h)}catch(g){let y=P(g);throw A(l.value)?new Error(`Failed loading Contentful entry '${l.value}' referenced in parameter '${f}': ${y}`):new Error(`Failed loading Contentful entry '${p}' from source '${(m=l.value.source)!=null?m:"default"}' referenced in parameter '${f}': ${y}`)}finally{console.timeEnd(`fetch entry ${p}`)}}},limitPolicy:d}}function b(e){var t;return e.type===N[0]&&(((t=e.value)==null?void 0:t.entryId)||typeof e.value=="string")}function A(e){return typeof e=="string"}function F(e){return!(!e||!A(e)&&!e.entryId)}function M({clients:e,parameterValue:t,parameterName:n,component:o,context:c}){if(A(t)){let d=e.getClient({isPreviewClient:c.preview});if(!d)throw new Error(`Parameter '${n}' in component '${o.type}' has a value '${t}' that is not compatible with multi-space/environment usage. If you wish to use multiple spaces/environments, you must convert your Canvas component parameters to the multi-space/environment compatible version. Otherwise, you can continue to use your parameters as-is, but must specify one of the clients provided to the Contentful enhancer as the 'default' client by registering it without specifying a source key.`);return d}let{source:i="default"}=t,a=e.getClient({source:i,isPreviewClient:c.preview});if(!a)throw new Error(`No Contentful client could be resolved for source key '${i}' referenced in parameter '${n} in component '${o.type}'. Ensure that the 'clients' property you are passing to the enhancer has a client instance registered for the source key.`);return a}var I={select:"fields",include:1},Q=Object.freeze(["contentfulMultiEntry"]);function J({clients:e,createQuery:t,limitPolicy:n}){if(!e)throw new Error("No Contentful clients were provided to the enhancer. You must provide at least one client via the ContentfulClientList.");return{enhanceOne:async function({parameter:i,parameterName:a,component:d,context:s}){var l,f;if(W(i)){if(!X(i.value))return null;let u=T({clients:e,parameterName:a,parameterValue:i.value,component:d,context:s}),r=i.value.entries,C=(l=t==null?void 0:t({parameter:i,parameterName:a,component:d,defaultQuery:{...I},context:s}))!=null?l:I;try{return console.time(`fetch entries ${r.join()}`),(await u.getEntries({"sys.id[in]":r.join(),limit:r.length,...C})).items}catch(m){let E=P(m);throw new Error(`Failed loading Contentful entries '${r.join()}' from source '${(f=i.value.source)!=null?f:"default"}' referenced in parameter '${a}': ${E}`)}finally{console.timeEnd(`fetch entries ${r.join()}`)}}},limitPolicy:n||x}}function W(e){return e.type===Q[0]}function X(e){var t;return!(!e||!((t=e.entries)!=null&&t.length))}var _=Object.freeze(["contentfulQuery"]),S={select:"fields",include:1};function Z({clients:e,createQuery:t,limitPolicy:n}){if(!e)throw new Error("No Contentful clients were provided to the enhancer. You must provide at least one client via the ContentfulClientList.");return{enhanceOne:async function({parameter:i,parameterName:a,component:d,context:s}){var l,f;if(ee(i)){if(!te(i.value))return null;let u=T({clients:e,parameterName:a,parameterValue:i.value,component:d,context:s}),r=i.value,C=ne(r.count),m=(l=t==null?void 0:t({parameter:i,parameterName:a,component:d,defaultQuery:{...S},context:s}))!=null?l:S,E=`fetch query: ${C} entries with '${r.contentType}' content type`;try{return console.time(E),(await u.getEntries({content_type:r.contentType,order:R(r.sortBy,r.sortOrder),limit:C,...m})).items}catch(p){let h=P(p);throw new Error(`Failed loading Contentful entries with '${r.contentType}' content type from source '${(f=r.source)!=null?f:"default"}' referenced in parameter '${a}': ${h}`)}finally{console.timeEnd(E)}}},limitPolicy:n||x}}function ee(e){return e.type===_[0]}function te(e){return!(!e||!e.source||!e.contentType||typeof e.count=="undefined")}function ne(e){return!e||e<1?1:e>1e3?1e3:e}var j=require("@contentful/rich-text-html-renderer"),re=({parameter:e})=>{let t=e.value;if(!t)return t;if(!oe(t))return k(t),t;for(let n of t)k(n);return t};function k(e){var t;typeof(e==null?void 0:e.fields)=="object"&&Object.entries((t=e.fields)!=null?t:{}).forEach(([n,o])=>{typeof o=="object"&&"nodeType"in o&&o.nodeType==="document"&&(e.fields[n]=(0,j.documentToHtmlString)(o))})}function oe(e){return Array.isArray(e)}0&&(module.exports={CANVAS_CONTENTFUL_MULTI_PARAMETER_TYPES,CANVAS_CONTENTFUL_PARAMETER_TYPES,CANVAS_CONTENTFUL_QUERY_PARAMETER_TYPES,ContentfulClientList,contentfulRichTextToHtmlEnhancer,createContentfulEnhancer,createContentfulMultiEnhancer,createContentfulQueryEnhancer});
